# ДЗ 1 | Алексей Коледаев

## Список файлов и поиснения

- [README.md](README.md) - в представлении не нуждается
- [model_artifacts.pkl](model_artifacts.pkl) - модель, OHE обученный в блокноте, разделение на категориальные и числовые колонки (все используется для подготовки данных в приложении)
- [train_profile.html](train_profile.html) - ydata дашборд
- [HW_1_koledaev.ipynb](HW_1_koledaev.ipynb) - ноутбук с основной дз
- [cars_train.csv](cars_train.csv) - цсв для подготовки eda в streamlit
- [app.py](app.py) - streamlit-приложение
- [best_model.pkl](best_model.pkl) - просто лучшая модель, на всякий случай сохранил отдельно, если будет Ridge долго обучатся. Импортировать после OHE и подготовки данных

## Что было сделано

1. **Загрузка и первичный анализ данных (EDA)**

- Были загружены тренировочный и тестовый датасеты с информацией об автомобилях
- Изучены размеры таблиц, типы признаков, наличие пропусков, выбросов и дубликатов
- Построены парные графики и матрица корреляций для числовых признаков, а так же ящик с усами и скрипочный график , что позволило оценить связи между признаками и целевой переменной

2. **Предобработка данных (чистка и приведение типов)**

- Столбцы mileage, engine, max_power из строкового формата с единицами измерения были преобразованы в числовой формат
- Столбец torque был удалён, поскольку его обработка усложняет задачу и не являлась обязательной частью домашнего задания
- Пропуски в числовых столбцах были заполнены медианами, рассчитанными по train-выборке, те же значения медиан использовались для заполнения пропусков в тестовой выборке
- Признаки engine и seats были приведены к int
- Из тренировочного набора были удалены полные дубликаты и скрытые дубликаты

3. **Моделирование на числовых признаках**

- Была обучена базовая модель линейной регрессии только на числовых признаках. Для неё были посчитаны метрики на train и test:
  - R2
  - MSE
- Затем те же признаки были стандартизированы, и на стандартизованных данных обучалась линейная регрессия. Стандартизация не изменила качество модели (как и ожидалось, обычная линейная регрессия не чувствительна к масштабу признаков)
- На стандартизованных данных были обучены модели с регуляризацией:
  - Lasso
  - ElasticNet
- Для этих моделей были подобраны гиперпараметры по cv с 10 фолдами, посчитаны R2 и MSE на train и test, а также проанализировано зануление

4. **Добавление категориальных признаков**

- Столбец name был проанализирован и в рамках бонусного задания из него выделен признак brand, который был использован как категориальный признак. Сам столбец name после этого был удалён
- Были выделены категориальные признаки (fuel, seller_type, transmission, owner, brand) и столбец seats, который также был включён в категориальные признаки
- Для категориальных признаков было выполнено OneHot-кодирование с удалением первого признака, что позволило избегать мультиколлинеарности и корректно обрабатывать новые категории на этапе инференса
- Финальный набор признаков представлял собой конкатенацию:
  - числовых признаков (year, km_driven, mileage, engine, max_power)
  - OHE-кодированных категориальных признаков (включая brand и seats)

5. **Финальная модель (Ridge-регрессия)**

- На полном наборе признаков (числовые + категориальные после OHE) была обучена Ridge
- Параметр регуляризации alpha подбирался по сетке logspace(-5, 5, 50) с помощью GridSearchCV (10-фолдовая кросс-валидация, метрика - R2)
- Для лучшей модели были вычислены метрики R2 и MSE на тренировочной и тестовой выборках и проведено сравнение с предыдущими моделями на одних числовых признаках

6. **Бизнесовая метрика**

- Была реализована кастомная метрика business_metric, равная доле объектов, для которых относительная ошибка предсказания не превышает 10% от реальной цены
- Эта метрика была посчитана для всех обученных моделей, лучшая по ней также оказалась финальная Ridge-модель с числовыми и категориальными признаками

7. **Сохранение артефактов и сервис на Streamlit**

- В ноутбуке был сформирован объект с артефактами (модель Ridge, OneHotEncoder, списки num_cols и cat_cols), который сохранён в pickle-файл model_artifacts.pkl
- Было разработано Streamlit-приложение, которое:
  - визуализирует основные графики EDA
  - позволяет загружать CSV-файл с объектами и получать для них предсказания цены
  - поддерживает ручной ввод признаков одного автомобиля
  - визуализирует веса модели (коэффициенты Ridge по признакам)

## 2. Результаты и метрики

Основной набор метрик использовался следующий:

- R2 (коэффициент детерминации) для train и test
- MSE (mean squared error) для train и test
- бизнес-метрика (business_metric) - доля объектов с относительной ошибкой не более 10%.

Качественно результаты можно описать так:

1. **Базовая линейная регрессия на числовых признаках**

- R2(test) ~ 0.59
- Модель объясняет около 59% вариации стоимости автомобиля
- R2(train) и R2(test) близки, следовательно, явного переобучения нет, но модель ограничена линейностью и отсутствием категориальных признаков

2. **Lasso и ElasticNet на тех же признаках**

- С подобранными по кросс-валидации параметрами регуляризации качество на тесте либо сопоставимо с базовой линейной регрессией, либо немного хуже
- Lasso частично зануляет коэффициенты, однако для данного набора признаков это приводит скорее к потере качества, чем к выигрышу (число признаков невелико, и большинство из них информативны)

3. **Ridge-регрессия на числовых + категориальных (OHE) признаках**

- R2(train) ~ 0.77
- R2(test) ~ 0.77
- MSE заметно ниже, чем у моделей на одних числовых признаках.
- Это говорит о том, что:
  - добавление категориальных признаков (fuel, seller_type, transmission, owner, brand, seats) существенно улучшает качество
  - гребневая регуляризация помогает стабилизировать модель и избежать переобучения при увеличении размерности признакового пространства

4. **Бизнес-метрика**

- Доля объектов с относительной ошибкой <= 10% у базовой линейки на числах оказалась ниже, чем у финальной Ridge-модели
- Финальная модель демонстрирует наибольшую долю приемлемых предсказаний с точки зрения бизнеса, то есть именно она лучше всего отвечает требованию ошибаться не больше, чем на 10%

## 3. Что дало наибольший прирост качества

1. **Добавление категориальных признаков** и их корректное кодирование через OneHotEncoder

   Использование только числовых признаков ограничивает модель, так как важная информация о типе топлива, типе продавца, типе владения и бренде автомобиля остаётся неучтённой. После добавления этих признаков и их кодирования модель смогла лучше разделять разные сегменты рынка

2. **Использование Ridge-регрессии** на расширенном признаковом пространстве

   При большом количестве OHE-признаков гребневая регуляризация помогает контролировать величины коэффициентов и снижать риск переобучения. В результате удалось получить модель, которая показывает высокое качество как на train, так и на test без сильного разброса метрик

## 4. Что сделать не удалось и почему

- Честно говоря, я сам не понимаю, что удалось сделать, а что - нет. В некоторых заданиях, как например в streamlit я просто не понял формулировку (EDA должно выглядеть как те же графики, только для загружаемого датасета, или мы кешируем оригинальный и показываем графики для него), сделал как посчитал нужным. Были еще некоторые задания, где приходилось "додумывать". К сожалению, я не могу быть уверен, правильно ли я додумал или нет. Так что можно считать, что мне не удалось быть уверенным в своем решением
- В целом, кажется, что выполнение заданий мне удалось
- Модель иногда выдает отрицательную цену, стоило бы поработать с этим, да и в целом, думаю, можно было бы логарифмировать целевую переменную, кажется, так мы сможем лучшие метрики получить

## 5. Оценка разработанного сервиса (Streamlit-приложения)

Разработанное приложение на Streamlit реализует три основных сценария:

1. **EDA-раздел**

- Показывает первые строки тренировочного набора
- Визуализирует распределение целевой переменной и отдельных числовых признаков
- Позволяет строить scatter-графики зависимости цены от выбранного числового признака
- Показывает boxplot зависимости цены от выбранного категориального признака

2. **Прогноз по CSV и ручной ввод**

- Пользователь может загрузить CSV-файл с объектами в формате, совместимом с обучающим набором, и получить предсказания цены для всех строк
- Поддерживается ручной ввод признаков одного автомобиля через интерактивную форму (год, пробег, мощность, тип топлива, бренд и тд.), после чего выводится предсказанная моделью цена, для демонстрации на единичных данных

3. **Визуализация весов модели**

- Приложение отображает коэффициенты Ridge-модели (как численно, так и в виде горизонтального bar chart), что позволяет оценить, какие признаки оказывают наибольшее влияние на прогноз
- Это повышает прозрачность модели и делает результат более понятным
